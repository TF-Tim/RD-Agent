# ───────────────────────────── GLOBAL SETTINGS ─────────────────────────────
qlib_init:
    provider_uri: "~/.qlib/qlib_data/us_data"
    region: us

market:    &market     sp500
benchmark: &benchmark  ^GSPC

# ───────────────────────────── DATA HANDLER ─────────────────────────────
data_handler_config: &data_handler_config
    start_time:      2010-01-01
    end_time:        2023-12-31
    fit_start_time:  2010-01-01
    fit_end_time:    2016-12-31
    instruments: *market

    infer_processors:
      - class: FilterCol
        kwargs:
            fields_group: feature
            col_list: ["RESI5","WVMA5","RSQR5","KLEN","RSQR10","CORR5","CORD5","CORR10",
                       "ROC60","RESI10","VSTD5","RSQR60","CORR60","WVMA60","STD5",
                       "RSQR20","CORD60","CORD10","CORR20","KLOW"]
      - class: RobustZScoreNorm
        kwargs: {fields_group: feature, clip_outlier: true}
      - class: Fillna
        kwargs: {fields_group: feature}

    learn_processors:
      - class: DropnaLabel
      - class: CSRankNorm
        kwargs: {fields_group: label}

    label: ["Ref($close, -2) / Ref($close, -1) - 1"]

# ───────────────────────────── BACK-TEST SETTINGS (ANCHOR) ─────────────────────────────
backtest: &backtest
    start_time: 2020-01-01
    end_time:   2023-12-31
    account:    100000000
    benchmark:  *benchmark
    exchange_kwargs:
        limit_threshold: 0.099
        deal_price:      close
        open_cost:       0.0005
        close_cost:      0.0015
        min_cost:        1

# ───────────────────────────── PORT ANALYSIS ─────────────────────────────
port_analysis_config: &port_analysis_config
    strategy:
        class: TopkDropoutStrategy
        module_path: qlib.contrib.strategy
        kwargs: {signal: <PRED>, topk: 50, n_drop: 5}
    backtest: *backtest               # ← re-use the anchor

# ───────────────────────────── TASK DEFINITION ─────────────────────────────
task:
    model:
        class: LGBModel
        module_path: qlib.contrib.model.gbdt
        kwargs:
            loss:              mse
            colsample_bytree:   0.90
            learning_rate:     0.15
            subsample:         0.90
            lambda_l1:         50
            lambda_l2:         120
            max_depth:         8
            num_leaves:        256
            num_threads:       20

    dataset:
        class: DatasetH
        module_path: qlib.data.dataset
        kwargs:
            handler:
                class: Alpha158
                module_path: qlib.contrib.data.handler
                kwargs: *data_handler_config
            segments:
                train: [2010-01-01, 2016-12-31]
                valid: [2017-01-01, 2019-12-31]
                test:  [2020-01-01, 2023-12-31]

    record:
      - class: SignalRecord
        module_path: qlib.workflow.record_temp
        kwargs: {model: <MODEL>, dataset: <DATASET>}
      - class: SigAnaRecord
        module_path: qlib.workflow.record_temp
        kwargs: {ana_long_short: false, ann_scaler: 252}
      - class: PortAnaRecord
        module_path: qlib.workflow.record_temp
        kwargs: {config: *port_analysis_config}
